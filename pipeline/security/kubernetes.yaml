k8s-checkov:
  stage: k8s-checkov
  allow_failure: true
  image:
    name: docker.io/bridgecrew/checkov:latest
    entrypoint:
      - "/usr/bin/env"
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  rules:
    - if: $SAST_DISABLED
      when: never
    - if: $CI_COMMIT_BRANCH
      exists:
        - "kubernetes/*.yaml"
  script:
    - script -q -c 'checkov -d . ; echo $? > CKVEXIT'
    - exit $(cat CKVEXIT)

k8s-kics:
  stage: k8s-kics
  image:
    name: docker.io/checkmarx/kics:latest
  script:
    - scan -p kubernetes/*
